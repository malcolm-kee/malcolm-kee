---
import { clsx } from 'clsx';
import { Button } from './Button';
import { BookmarkIcon } from './icons';

export interface Props {
  saveKey: string;
  pageTitle: string;
  pageDescription?: string;
  className?: string;
}

const { className, saveKey, pageTitle, pageDescription } = Astro.props;

const { pathname } = Astro.url;
---

<Button
  data-savekey={saveKey}
  data-pagetitle={pageTitle}
  data-pagedescription={pageDescription}
  data-path={pathname}
  className={clsx('SavePageButton hidden', className)}
>
  <BookmarkIcon checkMarkClass="SavePageButtonCheckmark transition opacity-0" />
  <span class="SavePageButtonLabel">Save</span>
</Button>

<script>
  import {
    loadPageSaveCapability,
    removePage,
    requestPersistentStorage,
    savePageDependencies,
  } from '~/data/offline-helpers';

  const saveStateByPage = new Map<string, boolean>();

  document.querySelectorAll<HTMLButtonElement>('.SavePageButton').forEach((button) => {
    const { dataset } = button;

    if (
      button instanceof HTMLButtonElement &&
      dataset.savekey &&
      dataset.pagetitle &&
      dataset.path
    ) {
      const saveKey = dataset.savekey;

      const pageInfo = {
        title: dataset.pagetitle,
        path: dataset.path,
        ...(dataset.pagedescription
          ? {
              description: dataset.pagedescription,
            }
          : {}),
      };

      loadPageSaveCapability(saveKey, pageInfo).then((capability) => {
        if (capability.allowed) {
          button.classList.remove('hidden');

          const checkMark = button.querySelector('.SavePageButtonCheckmark');
          const label = button.querySelector('.SavePageButtonLabel');

          if (capability.saved) {
            checkMark && checkMark.classList.remove('opacity-0');
            if (label) label.textContent = 'Saved';
            button.dataset.success = 'true';
          }

          saveStateByPage.set(saveKey, capability.saved);

          button.addEventListener('click', () => {
            const sameKeyButtons = document.querySelectorAll<HTMLButtonElement>(
              `.SavePageButton[data-savekey="${saveKey}"]`
            );

            const isSaving = !saveStateByPage.get(saveKey);

            sameKeyButtons.forEach((sameKeyButton) => {
              sameKeyButton.disabled = true;

              const checkIcon = sameKeyButton.querySelector('.SavePageButtonCheckmark');
              const buttonLabel = sameKeyButton.querySelector('.SavePageButtonLabel');

              const operation = isSaving
                ? requestPersistentStorage().then(() =>
                    savePageDependencies(saveKey, pageInfo, capability.dependencies)
                  )
                : removePage(saveKey);

              operation.then(() => {
                sameKeyButton.disabled = false;
                saveStateByPage.set(saveKey, isSaving);

                if (checkIcon) {
                  checkIcon.classList.toggle('opacity-0');
                }
                if (buttonLabel) {
                  buttonLabel.textContent = isSaving ? 'Saved' : 'Save';
                }
                if (isSaving) {
                  sameKeyButton.dataset.success = 'true';
                } else {
                  delete sameKeyButton.dataset.success;
                }
              });
            });
          });
        }
      });
    }
  });
</script>
