---
import { clsx } from 'clsx';
import { Button } from './Button';
import { BookmarkIcon } from './icons';

export interface Props {
  saveKey: string;
  pageTitle: string;
  pageDescription?: string;
  className?: string;
}

const { className, saveKey, pageTitle, pageDescription } = Astro.props;

const { pathname } = Astro.url;
---

<Button
  data-savekey={saveKey}
  data-pagetitle={pageTitle}
  data-pagedescription={pageDescription}
  data-path={pathname}
  className={clsx('SavePageButton hidden saveable:inline-flex min-w-[90px]', className)}
>
  <BookmarkIcon checkMarkClass="SavePageButtonCheckmark transition opacity-0" />
  <span class="SavePageButtonLabel text-xl sm:text-sm">Save</span>
</Button>

<script>
  import {
    loadPageSaveCapability,
    removePage,
    requestPersistentStorage,
    savePageDependencies,
  } from '~/data/offline-helpers';
  import { onOnlineStatusChange } from '~/lib/check-online-status';

  const saveStateByPage = new Map<string, boolean>();

  const saveButtons = document.querySelectorAll<HTMLButtonElement>('.SavePageButton');

  onOnlineStatusChange((isOnline) =>
    saveButtons.forEach((button) => {
      button.disabled = !isOnline;
    })
  );

  saveButtons.forEach((button) => {
    const { dataset } = button;

    if (
      button instanceof HTMLButtonElement &&
      dataset.savekey &&
      dataset.pagetitle &&
      dataset.path
    ) {
      const saveKey = dataset.savekey;

      const pageInfo = {
        title: dataset.pagetitle,
        path: dataset.path,
        ...(dataset.pagedescription
          ? {
              description: dataset.pagedescription,
            }
          : {}),
      };

      loadPageSaveCapability(saveKey, pageInfo).then((capability) => {
        if (capability.allowed) {
          button.classList.remove('hidden');

          const checkMark = button.querySelector('.SavePageButtonCheckmark');
          const label = button.querySelector('.SavePageButtonLabel');

          if (capability.saved) {
            checkMark && checkMark.classList.remove('opacity-0');
            if (label) label.textContent = 'Saved';
            button.dataset.success = 'true';
          }

          saveStateByPage.set(saveKey, capability.saved);

          let isBusy = false;
          button.addEventListener('click', () => {
            if (isBusy) {
              return;
            }

            isBusy = true;

            const isSaving = !saveStateByPage.get(saveKey);

            const operation = isSaving
              ? requestPersistentStorage().then(() =>
                  savePageDependencies(saveKey, pageInfo, capability.dependencies)
                )
              : removePage(saveKey);

            operation.then(() => {
              isBusy = false;
              saveStateByPage.set(saveKey, isSaving);

              document
                .querySelectorAll<HTMLButtonElement>(`.SavePageButton[data-savekey="${saveKey}"]`)
                .forEach((sameKeyButton) => {
                  const checkIcon = sameKeyButton.querySelector('.SavePageButtonCheckmark');
                  const buttonLabel = sameKeyButton.querySelector('.SavePageButtonLabel');

                  if (checkIcon) {
                    checkIcon.classList.toggle('opacity-0');
                  }
                  if (buttonLabel) {
                    buttonLabel.textContent = isSaving ? 'Saved' : 'Save';
                  }
                  if (isSaving) {
                    sameKeyButton.dataset.success = 'true';
                  } else {
                    delete sameKeyButton.dataset.success;
                  }
                });
            });
          });
        } else {
          button.classList.add('!hidden');
        }
      });
    }
  });
</script>
