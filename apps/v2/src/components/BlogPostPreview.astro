---
import type { CollectionEntry } from 'astro:content';
import { clsx } from 'clsx';
import { ImageData } from '~/lib/cloudinary';
import { formatDate } from '~/lib/date';
import { CloudinaryImage } from './CloudinaryImage';

export interface Props {
  post: CollectionEntry<'blog'> & { heroImageInfo?: ImageData };
  isFeatured?: boolean;
  TitleElement?: 'h1' | 'h2' | 'h3' | 'h4';
  hideDate?: boolean;
  class?: string;
  roundedBg?: boolean;
}

const { post, isFeatured, TitleElement = 'h2', hideDate, roundedBg } = Astro.props;

const hasImage = post.heroImageInfo;
---

<article
  lang={post.data.lang}
  class={clsx(
    'blog-article',
    hasImage && 'relative',
    isFeatured
      ? 'z-10 py-4 bg-white min-h-[20rem] flex items-center'
      : 'pt-1 pb-3 @md/bloglist:grid @md/bloglist:grid-cols-4 @md/bloglist:gap-6',
    Astro.props.class
  )}
  data-shiny={!hasImage}
>
  {
    post.heroImageInfo && (
      <div
        class={clsx(
          'blog-hero-image-container absolute inset-0 w-full h-full opacity-20 overflow-hidden transition-opacity',
          isFeatured ? 'block' : 'hidden @md/bloglist:rounded-r-2xl'
        )}
        aria-hidden
      >
        <div class="blog-hero-image-wrapper h-full">
          <CloudinaryImage
            data={post.heroImageInfo}
            className={clsx(
              'blog-hero-image w-full min-h-full object-cover',
              isFeatured ? 'lg:-translate-y-1/3' : '@md/bloglist:-translate-y-1/3',
              !isFeatured && 'delayed-appear'
            )}
            alt=""
            loading={isFeatured ? 'eager' : 'lazy'}
          />
        </div>
      </div>
    )
  }
  {hasImage && <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-white" />}
  {
    !isFeatured && !hideDate && (
      <time class="hidden relative @md/bloglist:block pl-3 text-sm leading-6 text-zinc-400">
        {formatDate(post.data.pubDate)}
      </time>
    )
  }
  <div class="@md/bloglist:col-span-3 h-full w-full relative">
    <a href={`/blog/${post.slug}/`} class="block group/bloglink blog-link">
      {
        !hasImage && (
          <div
            class={clsx(
              'blog-content-bg absolute -inset-y-6 -inset-x-4 z-0',
              '@md/bloglist:-inset-x-6 @md/bloglist:rounded-2xl',
              'scale-95 bg-zinc-50 opacity-0 transition',
              'group-hover/bloglink:scale-100 group-hover/bloglink:opacity-100',
              roundedBg && 'rounded-2xl'
            )}
          />
        )
      }
      <div
        class={clsx(
          'blog-content-preview relative transition-all pr-2',
          hasImage && (isFeatured ? 'drop-shadow-sm' : 'backdrop-blur-sm')
        )}
      >
        {
          !hideDate && (
            <time
              class={clsx(
                'text-sm block mb-2 pl-3 border-l-2 text-zinc-400',
                isFeatured ? 'border-l-transparent' : 'border-l-zinc-100 @md/bloglist:hidden'
              )}
            >
              {formatDate(post.data.pubDate)}
            </time>
          )
        }
        <header>
          <TitleElement
            class={clsx(
              'blog-title font-techie font-semibold text-zinc-800 group-hover/bloglink:text-primary-500',
              isFeatured ? 'text-4xl px-3' : 'text-lg'
            )}
          >
            {post.data.title}
          </TitleElement>
        </header>
        {
          post.data.description && (
            <p
              class={clsx(
                'text-zinc-600 mt-2',
                isFeatured ? 'text-lg px-3 border-l-2 border-transparent' : 'text-sm'
              )}
            >
              {post.data.description}
            </p>
          )
        }
      </div>
    </a>
    {
      post.data.topics && post.data.topics.length > 0 && (
        <ul
          class={clsx(
            'relative mt-2 flex items-center flex-wrap gap-2 text-xs',
            isFeatured && 'px-3'
          )}
        >
          {post.data.topics.map((topic) => (
            <li>
              <a
                href={`/topic/${topic}`}
                class={clsx(
                  'topic-link block px-3 py-1.5 font-medium rounded-full transition-colors',
                  'text-zinc-600 bg-zinc-50 hover:text-primary-500 focus:text-primary-500 shadow-sm hover:shadow-primary-100'
                )}
              >
                {topic}
              </a>
            </li>
          ))}
        </ul>
      )
    }
  </div>
</article>
<script>
  import { setupShinyEffect } from '~/lib/shiny-effect';

  document.querySelectorAll('.blog-article[data-shiny]').forEach((previewElement) => {
    const link = previewElement.querySelector('.blog-link');
    const coverElement = previewElement.querySelector('.blog-content-bg');

    if (
      link &&
      link instanceof HTMLElement &&
      coverElement &&
      coverElement instanceof HTMLElement
    ) {
      setupShinyEffect(coverElement, link);
    }
  });

  document.querySelectorAll('.blog-link').forEach((blogLink) => {
    if (blogLink instanceof HTMLElement) {
      blogLink.addEventListener(
        'click',
        () => {
          try {
            (blogLink.style as any).viewTransitionName = 'hero-image';
          } catch (err) {
            console.error(err);
          }
        },
        { capture: true }
      );
    }
  });

  document.querySelectorAll('.topic-link').forEach((topicLink) => {
    if (topicLink instanceof HTMLElement) {
      topicLink.addEventListener(
        'click',
        () => {
          try {
            (topicLink.style as any).viewTransitionName = 'topic-title';
          } catch (err) {
            console.error(err);
          }
        },
        { capture: true }
      );
    }
  });
</script>

<style>
  @keyframes zoom {
    from {
      transform: scale(1.2);
    }

    to {
      transform: scale(1.8);
    }
  }

  @keyframes fade {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  .delayed-appear {
    opacity: 0;
    animation: fade 100ms ease-in 200ms forwards;
  }

  .blog-hero-image-wrapper {
    animation: zoom 5000ms linear alternate infinite;
    animation-play-state: paused;
  }

  .blog-article:hover .blog-hero-image-wrapper,
  .blog-article:focus-within .blog-hero-image-wrapper {
    animation-play-state: running;
  }

  .blog-article:hover .blog-hero-image-container,
  .blog-article:focus-within .blog-hero-image-container {
    display: block;
  }

  .blog-article:has(.blog-link:hover, .blog-link:focus) .blog-hero-image-container {
    opacity: 0.4;
  }
</style>
