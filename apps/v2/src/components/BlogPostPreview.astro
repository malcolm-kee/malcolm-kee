---
import type { CollectionEntry } from 'astro:content';
import { formatDate } from '~/lib/date';
import { clsx } from 'clsx';

export interface Props {
  post: CollectionEntry<'blog'>;
  isFeatured?: boolean;
}

const { post, isFeatured } = Astro.props;
---

<article
  lang={post.data.lang}
  class={clsx(
    'blog-article py-4',
    post.data.heroImage && 'relative',
    isFeatured
      ? 'z-10 -mx-2 py-4 bg-white min-h-[20rem] flex items-center'
      : '@md/bloglist:grid @md/bloglist:grid-cols-4 @md/bloglist:gap-6'
  )}
>
  {
    post.data.heroImage && (
      <div
        class={clsx(
          'blog-hero-image-container absolute inset-0 w-full h-full opacity-20 overflow-hidden',
          isFeatured ? 'block' : 'hidden'
        )}
        aria-hidden
      >
        <div class="blog-hero-image-wrapper">
          <img
            class={clsx(
              'blog-hero-image w-full object-cover -translate-y-1/3',
              !isFeatured && 'delayed-appear'
            )}
            src={post.data.heroImage}
            alt=""
            loading={isFeatured ? 'eager' : 'lazy'}
          />
        </div>
      </div>
    )
  }
  {
    post.data.heroImage && (
      <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-white via-white/0 to-white/0" />
    )
  }
  {
    !isFeatured && (
      <time class="hidden relative @md/bloglist:block pl-3 text-sm leading-6 text-zinc-400">
        {formatDate(post.data.pubDate)}
      </time>
    )
  }
  <div class="@md/bloglist:col-span-3 relative">
    <a href={`/blog/${post.slug}`} class="block group/bloglink blog-link">
      {
        !post.data.heroImage && (
          <div
            class={clsx(
              'absolute -inset-y-6 -inset-x-4 z-0',
              '@md/bloglist:-inset-x-6 @md/bloglist:rounded-2xl',
              'scale-95 bg-zinc-50 opacity-0 transition',
              'group-hover/bloglink:scale-100 group-hover/bloglink:opacity-100'
            )}
          />
        )
      }
      <div
        class={clsx(
          'relative',
          post.data.heroImage &&
            (isFeatured ? 'drop-shadow-sm' : 'backdrop-blur-sm')
        )}
      >
        <time
          class={clsx(
            'text-sm block mb-2 pl-3 border-l-2 border-l-zinc-100 text-zinc-400',
            !isFeatured && '@md/bloglist:hidden'
          )}>{formatDate(post.data.pubDate)}</time
        >
        <header>
          <h2
            class={clsx(
              'font-semibold tracking-tight text-zinc-800',
              isFeatured ? 'text-3xl' : 'text-base'
            )}
          >
            {post.data.title}
          </h2>
        </header>
        {
          post.data.description && (
            <p
              class={clsx(
                'text-zinc-600 mt-2',
                isFeatured ? 'text-lg' : 'text-sm'
              )}
            >
              {post.data.description}
            </p>
          )
        }
      </div>
    </a>
    {
      post.data.topics && post.data.topics.length > 0 && (
        <ul class="relative mt-2 flex items-center gap-2 text-xs">
          {post.data.topics.map((topic) => (
            <li>
              <span class="block px-3 py-1.5 font-medium text-zinc-600 rounded-full bg-zinc-100">
                {topic}
              </span>
            </li>
          ))}
        </ul>
      )
    }
  </div>
</article>

<style>
  @keyframes zoom {
    from {
      transform: scale(1);
    }

    to {
      transform: scale(1.3);
    }
  }

  @keyframes fade {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  .delayed-appear {
    opacity: 0;
    animation: fade 100ms ease-in 200ms forwards;
  }

  .blog-hero-image-wrapper {
    transform-origin: left bottom;
    animation: zoom 5000ms linear alternate infinite;
    animation-play-state: paused;
  }

  .blog-article:has(.blog-link:hover) .blog-hero-image-wrapper,
  .blog-article:has(.blog-link:focus) .blog-hero-image-wrapper {
    animation-play-state: running;
  }

  .blog-article:has(.blog-link:hover) .blog-hero-image-container,
  .blog-article:has(.blog-link:focus) .blog-hero-image-container {
    display: block;
  }
</style>
