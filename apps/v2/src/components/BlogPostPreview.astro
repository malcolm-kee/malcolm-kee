---
import type { CollectionEntry } from 'astro:content';
import { formatDate } from '~/lib/date';
import { clsx } from 'clsx';

export interface Props {
  post: CollectionEntry<'blog'>;
  isFeatured?: boolean;
  TitleElement?: 'h1' | 'h2' | 'h3' | 'h4';
  hideDate?: boolean;
}

const { post, isFeatured, TitleElement = 'h2', hideDate } = Astro.props;
---

<article
  lang={post.data.lang}
  class={clsx(
    'blog-article py-4',
    post.data.heroImage && 'relative',
    isFeatured
      ? 'z-10 -mx-2 py-4 bg-white min-h-[20rem] flex items-center'
      : '@md/bloglist:grid @md/bloglist:grid-cols-4 @md/bloglist:gap-6'
  )}
>
  {
    post.data.heroImage && (
      <div
        class={clsx(
          'blog-hero-image-container absolute inset-0 w-full h-full opacity-20 overflow-hidden transition-opacity',
          isFeatured ? 'block' : 'hidden'
        )}
        aria-hidden
      >
        <div class="blog-hero-image-wrapper h-full">
          <img
            class={clsx(
              'blog-hero-image w-full min-h-full object-cover',
              isFeatured
                ? 'lg:-translate-y-1/3'
                : '@md/bloglist:-translate-y-1/3',
              !isFeatured && 'delayed-appear'
            )}
            src={post.data.heroImage}
            alt=""
            loading={isFeatured ? 'eager' : 'lazy'}
          />
        </div>
      </div>
    )
  }
  {
    post.data.heroImage && (
      <div class="absolute inset-0 w-full h-full bg-gradient-to-br from-white" />
    )
  }
  {
    !isFeatured && !hideDate && (
      <time class="hidden relative @md/bloglist:block pl-3 text-sm leading-6 text-zinc-400">
        {formatDate(post.data.pubDate)}
      </time>
    )
  }
  <div class="@md/bloglist:col-span-3 h-full relative">
    <a href={`/blog/${post.slug}`} class="block group/bloglink blog-link">
      {
        !post.data.heroImage && (
          <div
            class={clsx(
              'absolute -inset-y-6 -inset-x-4 z-0',
              '@md/bloglist:-inset-x-6 @md/bloglist:rounded-2xl',
              'scale-95 bg-zinc-50 opacity-0 transition',
              'group-hover/bloglink:scale-100 group-hover/bloglink:opacity-100'
            )}
          />
        )
      }
      <div
        class={clsx(
          'blog-content-preview relative transition-all pr-2',
          post.data.heroImage &&
            (isFeatured ? 'drop-shadow-sm' : 'backdrop-blur-sm')
        )}
      >
        {
          !hideDate && (
            <time
              class={clsx(
                'text-sm block mb-2 pl-3 border-l-2 border-l-zinc-100 text-zinc-400',
                !isFeatured && '@md/bloglist:hidden'
              )}
            >
              {formatDate(post.data.pubDate)}
            </time>
          )
        }
        <header>
          <TitleElement
            class={clsx(
              'blog-title font-semibold tracking-tight text-zinc-800',
              isFeatured
                ? 'text-3xl px-3 border-l-2 border-transparent'
                : 'text-base'
            )}
          >
            {post.data.title}
          </TitleElement>
        </header>
        {
          post.data.description && (
            <p
              class={clsx(
                'text-zinc-600 mt-2',
                isFeatured
                  ? 'text-lg px-3 border-l-2 border-transparent'
                  : 'text-sm'
              )}
            >
              {post.data.description}
            </p>
          )
        }
      </div>
    </a>
    {
      post.data.topics && post.data.topics.length > 0 && (
        <ul
          class={clsx(
            'relative mt-2 flex items-center flex-wrap gap-2 text-xs',
            isFeatured && 'px-3'
          )}
        >
          {post.data.topics.map((topic) => (
            <li>
              <a
                href={`/topic/${topic}`}
                class="topic-link block px-3 py-1.5 font-medium text-zinc-600 rounded-full bg-zinc-100 hover:bg-zinc-200"
              >
                {topic}
              </a>
            </li>
          ))}
        </ul>
      )
    }
  </div>
</article>

<script>
  document.querySelectorAll('.blog-link').forEach((blogLink) => {
    if (blogLink instanceof HTMLElement) {
      blogLink.addEventListener(
        'click',
        () => {
          try {
            (blogLink.style as any).viewTransitionName = 'hero-image';
          } catch (err) {
            console.error(err);
          }
        },
        { capture: true }
      );
    }
  });

  document.querySelectorAll('.topic-link').forEach((topicLink) => {
    if (topicLink instanceof HTMLElement) {
      topicLink.addEventListener(
        'click',
        () => {
          try {
            (topicLink.style as any).viewTransitionName = 'topic-title';
          } catch (err) {
            console.error(err);
          }
        },
        { capture: true }
      );
    }
  });
</script>

<style>
  @keyframes zoom {
    from {
      transform: scale(1.2);
    }

    to {
      transform: scale(1.8);
    }
  }

  @keyframes fade {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  .delayed-appear {
    opacity: 0;
    animation: fade 100ms ease-in 200ms forwards;
  }

  .blog-hero-image-wrapper {
    animation: zoom 5000ms linear alternate infinite;
    animation-play-state: paused;
  }

  .blog-article:hover .blog-hero-image-wrapper,
  .blog-article:focus-within .blog-hero-image-wrapper {
    animation-play-state: running;
  }

  .blog-article:hover .blog-hero-image-container,
  .blog-article:focus-within .blog-hero-image-container {
    display: block;
  }

  .blog-article:has(.blog-link:hover, .blog-link:focus)
    .blog-hero-image-container {
    opacity: 0.4;
  }

  .blog-article:has(.blog-link:hover, .blog-link:focus) .blog-content-preview {
    @apply backdrop-blur;
  }
</style>
